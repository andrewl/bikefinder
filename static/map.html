<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Bikefinder</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
<script src="http://omnipotent.net/jquery.sparkline/2.1.2/jquery.sparkline.min.js.gz"></script>
<script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
<script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
<link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
<link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />
<link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
    </head>
    <body>

    <div id='map'></div>

    <script>
    L.mapbox.accessToken = 'pk.eyJ1IjoiYW5kcmV3bCIsImEiOiJJdDlBVy0wIn0.6iigHBr09SrVB3N8graGdA';

 // ADD YOUR BASE TILES
  var baseLayer = L.tileLayer('http://a.tiles.mapbox.com/v3/landplanner.map-4y9ngu48/{z}/{x}/{y}.png', {
    maxZoom: 18
  });
 
  // DEFINE THE CLUSTER LAYER
  var markers = L.markerClusterGroup();


// CALL THE GEOJSON HERE
  $.getJSON("/stations.json", function(data) {

    // CONSTRUCT THE MAP
    var map = L.mapbox.map('map', 'mapbox.streets');
    baseLayer.addTo(map);

    var geojson = L.geoJson(data, {
      onEachFeature: function (feature, layer) {
        // USE A CUSTOM MARKER
        if (feature.properties.docks < 5) {
          color = 'ffffff'
        }
        else if (feature.properties.bikes < 5) {
          color = 'ff0000'
        }
        else {
          color = '00ff00'
        }

        layer.setIcon(L.mapbox.marker.icon({'marker-symbol': 'bicycle', 'marker-color': color}));
      }
    });
    markers.addLayer(geojson);
    map.fitBounds(markers.getBounds());

    markers.addTo(map);

    markers.on('click', function(e) {
        if (!e.layer.feature.properties) return;
        feature = e.layer.feature;
        var latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0])
        content = "<h1>" + feature.properties.name + "</h1><strong>Bikes: </strong>" + feature.properties.bikes + "<br/><strong>Docks: </strong>" + feature.properties.docks + "<br/><div id='sparkline_container' style='width: 200px'><div id='sparkline'>Loading history...</div></div>";
        var popup = L.popup()
        .setLatLng(latlng)
        .setContent(content)
        .openOn(map);

        $.getJSON("/station?i=" + feature.properties.i + "&s=" + feature.properties.s, function(data) {
          sparkline_data = []
          $.each(data, function(i, d) {
            sparkline_data.push(d.Bikes+":"+d.Docks)
          });
          $("#sparkline").sparkline(sparkline_data, {type: 'bar', barWidth: 1,
              barSpacing: 0});
        });

      });

  });

</script>

</body>
</html>


