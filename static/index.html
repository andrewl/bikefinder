<html>
<head>
<link rel="stylesheet" href="css/malo.css" type="text/css"></link>
<script src="http://zeptojs.com/zepto.min.js"></script>
</head>
<body class="main">
<div id="type_selector" class="dp100">
  <div id="get_bikes" class="dp50 button">
  I want a bike
  </div>
  <div id="get_freedocks" class="dp50 button">
  I want a dock
  </div>
</div>
<div id="bike_results" class="dp100 results"></div>
<div id="freedocks_results" class="dp100 results"></div>
</body>
<script>
Zepto(function($){
  $('#type_selector .button').on('click', function(e) {
    if ($(this).attr("id") == "get_bikes") {
      navigator.geolocation.getCurrentPosition(get_bikes);
    }
    else {
      navigator.geolocation.getCurrentPosition(get_freedocks);
    }
  });

  function get_bikes(position) {
    get_results(position, "/bikes-near", "bikes", "#bike_results")
  }

  function get_freedocks(position) {
    get_results(position, "/freedocks-near", "docks", "#freedocks_results")
  }

  function get_results(position, url, property, results_selector) {
    $('.results').hide();
    $(results_selector).empty();
    $(results_selector).show();
    $.ajax({type: 'GET',
            url: '/bikes-near',
            data: { lat: position.coords.latitude, lon: position.coords.longitude },
            success: function(data) {
              $(data).each(function(index) {
                lon = this.geometry.coordinates[0];
                lat = this.geometry.coordinates[1];
                map_url = "https://api.mapbox.com/v4/mapbox.streets/url-https%3A%2F%2Fmapbox.com%2Fimg%2Frocket.png("+lon+","+lat+")/"+lon+","+lat+",15/256x256@2x.png?access_token=pk.eyJ1IjoiYW5kcmV3bCIsImEiOiJJdDlBVy0wIn0.6iigHBr09SrVB3N8graGdA";
                $(results_selector).append("<div map_url='"+map_url+"'><p>" + this.properties.name + " (Updated: " + this.properties.updated + ") " + this.properties[property] + " " + property + ". <span class='show_map_link'>Show Map</span></p><img src='' style='display: none;'/></div>");
              });
              $(results_selector + " span.show_map_link").on('click', function(e) {
                if ($(this).hasClass('open')) {
                  img = $(this).parent().parent().find('img');
                  img.hide();
                  $(this).removeClass('open');
                  $(this).html("Show map");
                }
                else {
                  map_url = $(this).parent().parent().attr("map_url");
                  img = $(this).parent().parent().find('img');
                  img.attr('src', map_url);
                  img.show();
                  $(this).addClass('open');
                  $(this).html("Hide map");
                }
              });
            }
           });
  }
});

</script>
</html>
